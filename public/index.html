<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIDquake - C64 SID Music Linker</title>
    <link rel="stylesheet" href="genesis-header.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Genesis Project Common Header -->
    <header class="genesis-header">
        <div class="genesis-header-inner">
            <nav class="genesis-nav">
                <span class="genesis-nav-label">Genesis Project Sites</span>
                <ul class="genesis-nav-links">
                    <li><a href="https://c64gfx.com">C64GFX</a></li>
                    <li><a href="https://c64demo.com">C64Demo</a></li>
                    <li><a href="https://sidquake.c64demo.com" class="active">SIDquake</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="SIDquake.png" alt="SIDquake" class="logo" />
                <div class="header-info">
                    <h1>SIDquake</h1>
                    <p class="tagline">C64 SID Analyzer, Linker & Tool Suite</p>
                    <div class="version-badge">PREVIEW</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Simplified Upload Section -->
            <div class="upload-container">
                <!-- Drag & Drop Area -->
                <div class="upload-section" id="uploadSection">
                    <div class="upload-icon">üìÇ</div>
                    <div class="upload-text">Drop your SID file here</div>
                    <div class="upload-subtext">or use the buttons below</div>
                </div>

                <!-- Upload Buttons -->
                <div class="upload-buttons">
                    <button class="upload-btn" id="uploadBtn">
                        <span class="upload-btn-icon">üìÅ</span>
                        <span>Upload SID</span>
                    </button>
                    <button class="upload-btn" id="hvscBtn">
                        <span class="upload-btn-icon">üéµ</span>
                        <span>Browse HVSC</span>
                    </button>
                </div>

                <!-- HVSC Selected File Display (hidden by default) -->
                <div class="hvsc-selected" id="hvscSelected" style="display: none;">
                    <span class="selected-label">Selected:</span>
                    <span class="selected-file" id="selectedFile"></span>
                </div>

                <input type="file" id="fileInput" accept=".sid" style="display: none;">
            </div>

            <!-- Song Title Display -->
            <div class="song-title-section disabled" id="songTitleSection">
                <div class="song-title" id="songTitle">[ No SID Loaded ]</div>
                <div class="song-author" id="songAuthor">Load a SID file to begin</div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Analyzing SID file...</div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Information Section (File Info + Technical Details) -->
            <div class="section-group info-section disabled" id="infoSection">
                <div class="info-panels" id="infoPanels">
                    <!-- File Information Panel -->
                    <div class="panel">
                        <h2>üìÑ File Information</h2>
                        <div class="info-row">
                            <span class="info-label">Title:</span>
                            <span class="info-value editable" id="sidTitle" data-field="title" title="Click to edit">
                                <span class="text">-</span>
                                <span class="edit-icon">‚úèÔ∏è</span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Author:</span>
                            <span class="info-value editable" id="sidAuthor" data-field="author" title="Click to edit">
                                <span class="text">-</span>
                                <span class="edit-icon">‚úèÔ∏è</span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Copyright:</span>
                            <span class="info-value editable" id="sidCopyright" data-field="copyright" title="Click to edit">
                                <span class="text">-</span>
                                <span class="edit-icon">‚úèÔ∏è</span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Format:</span>
                            <span class="info-value" id="sidFormat">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Version:</span>
                            <span class="info-value" id="sidVersion">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Songs:</span>
                            <span class="info-value" id="sidSongs">-</span>
                        </div>
                    </div>

                    <!-- Technical Details Panel -->
                    <div class="panel">
                        <h2>‚öôÔ∏è Technical Details</h2>
                        <div class="info-row">
                            <span class="info-label">Load Address:</span>
                            <span class="info-value" id="loadAddress">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Init Address:</span>
                            <span class="info-value" id="initAddress">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Play Address:</span>
                            <span class="info-value" id="playAddress">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Memory Range:</span>
                            <span class="info-value" id="memoryRange">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">File Size:</span>
                            <span class="info-value" id="fileSize">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zero Page Usage:</span>
                            <span class="info-value" id="zpUsage">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Clock:</span>
                            <span class="info-value" id="clockType">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">SID Model:</span>
                            <span class="info-value" id="sidModel">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Play Calls/Frame:</span>
                            <span class="info-value" id="numCallsPerFrame">-</span>
                        </div>
                    </div>
                </div>

                <!-- Export Modified SID Button (moved here) -->
                <div class="export-modified-container">
                    <button class="export-button" id="exportModifiedSIDButton" disabled>
                        üíæ Export Modified SID
                    </button>
                    <div class="export-hint" id="exportHint">Edit the metadata above to enable export</div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="section-group export-section disabled" id="exportSection">
                <h2>üéÆ Choose Your Visualizer</h2>

                <!-- Visualizer Grid -->
                <div class="visualizer-grid" id="visualizerGrid">
                    <!-- Cards will be dynamically added here -->
                </div>

                <!-- Dynamic Options Container -->
                <div class="visualizer-options" id="visualizerOptions" style="display: none;">
                    <!-- Options will be dynamically added based on selected visualizer -->
                </div>

                <!-- Export Button -->
                <div class="export-buttons">
                    <button class="export-button" id="exportPRGButton" disabled>
                        üéÆ Export PRG
                    </button>
                </div>

                <div class="export-status" id="exportStatus"></div>
            </div>
        </div>
    </div>
    </div> <!-- End of site content wrapper -->
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚úî</div>
            <div class="modal-message" id="modalMessage">Success!</div>
        </div>
    </div>

    <!-- Load TSCrunch as ES module -->
    <script type="module">
        import { Cruncher, createSFX } from './lib/index.js';

        // Buffer polyfill for browser
        if (typeof Buffer === 'undefined') {
            window.Buffer = {
                from: function (data) {
                    if (data instanceof Uint8Array) return data;
                    if (Array.isArray(data)) return new Uint8Array(data);
                    return new Uint8Array(0);
                }
            };
        }

        // Make TSCrunch available globally
        window.TSCrunch = {
            compress: function (data, options = {}) {
                const {
                    prg = true,
                    sfx = true,
                    sfxMode = 0,
                    jumpAddress = 0x1000,
                    blank = false,
                    inplace = false
                } = options;

                // Convert data to array if needed
                const dataArray = Array.from(data);

                // Handle PRG format (skip load address)
                let sourceData = dataArray;
                let loadAddress = 0x0801;

                if (prg && dataArray.length >= 2) {
                    loadAddress = dataArray[0] | (dataArray[1] << 8);
                    sourceData = dataArray.slice(2);
                }

                // Create cruncher
                const cruncher = new Cruncher(sourceData);

                // Compress
                cruncher.ocrunch({
                    inplace: inplace,
                    verbose: false,
                    sfxMode: sfx
                });

                // Get compressed data
                let compressed = cruncher.crunched;

                // Create SFX if requested
                if (sfx) {
                    compressed = Array.from(createSFX(Buffer.from(compressed), {
                        jumpAddress: jumpAddress,
                        decrunchAddress: loadAddress,
                        optimalRun: cruncher.optimalRun,
                        sfxMode: sfxMode,
                        blank: blank
                    }));
                }

                // The SFX already has the load address from createSFX
                // Don't add it again!
                return new Uint8Array(compressed);
            }
        };

        // Signal that TSCrunch is ready
        window.dispatchEvent(new Event('tscrunch-ready'));
    </script>

    <!-- Add this before the closing </body> tag in index.html -->
    <div class="hvsc-modal" id="hvscModal">
        <div class="hvsc-modal-content">
            <button class="hvsc-modal-close" id="hvscModalClose">‚úï</button>
            <div class="hvsc-modal-body">
                <div class="browser-container" style="height: 100%; background: transparent;">
                    <div class="browser-header">
                        <div class="browser-title">HVSC SID Collection Browser</div>
                        <div class="browser-controls">
                            <button class="btn" id="homeBtn" onclick="hvscBrowser.navigateHome()" title="Go to home">
                                <i class="fas fa-home"></i>
                            </button>
                            <button class="btn" id="upBtn" onclick="hvscBrowser.navigateUp()" title="Go up one directory">
                                <i class="fas fa-level-up-alt"></i>
                            </button>
                            <input type="text" class="path-bar" id="pathBar" readonly>
                        </div>
                    </div>

                    <div class="browser-content">
                        <div class="file-panel">
                            <div class="panel-header">Files & Directories</div>
                            <div class="file-list" id="fileList">
                                <div class="loading">Loading directory</div>
                            </div>
                        </div>
                    </div>

                    <div class="status-bar">
                        <span id="itemCount">0 items</span>
                        <span style="margin-left: auto; color: #888; font-size: 11px;">Double-click to select a SID file</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regular scripts -->
    <script src="sidwinder.js"></script>
    <script src="sidwinder-core.js"></script>
    <script src="png-converter.js"></script>
    <script src="image-preview-manager.js"></script>
    <script src="compressor-manager.js"></script>
    <script src="prg-builder.js"></script>
    <script src="hvsc-browser.js"></script>
    <script src="ui.js"></script>
    <script src="visualizer-registry.js"></script>
    <script src="visualizer-configs.js"></script>
    <script src="floating-notes.js"></script>
    <script src="text-drop-zone.js"></script>

</body>
</html>